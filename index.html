<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Scientific Research Evaluation Points Calculator – Cycle 15 (Updated)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', Arial, sans-serif;
    background: #f0f2f5;
    color: #1e293b;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  .card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    margin: 0 auto 20px;
    max-width: 1400px;
    width: 100%;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    box-sizing: border-box;
  }
  h1 { margin: 0 0 5px; font-size: 22px; color: #0f1724; font-weight: 700; }
  .muted { color: #64748b; font-size: 14px; margin-bottom: 20px; }
  
  /* Table Styling */
  .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; min-height: 300px; }
  table { width: 100%; border-collapse: collapse; min-width: 1100px; }
  th, td {
    border-bottom: 1px solid #e2e8f0;
    border-right: 1px solid #e2e8f0;
    padding: 8px 10px;
    text-align: left;
    font-size: 13px;
    vertical-align: middle;
  }
  th:last-child, td:last-child { border-right: none; }
  th { background: #f8fafc; font-weight: 600; color: #475569; white-space: nowrap; }

  /* Inputs & Selects */
  input[type="text"], input[type="number"], select {
    width: 100%; padding: 6px 8px;
    border: 1px solid #cbd5e1; border-radius: 4px;
    font-size: 13px; box-sizing: border-box;
    font-family: inherit; transition: all 0.2s;
  }
  input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }

  /* Column Widths */
  .col-idx { width: 40px; text-align: center; }
  .col-title { width: 180px; }
  .col-journal { width: 220px; }
  .col-spec { width: 100px; }
  .col-eval { width: 90px; }
  .col-grade-sm { width: 85px; } /* Widened for calc button */
  .col-num { width: 60px; }
  .col-rank { width: 100px; }
  .col-check { width: 50px; text-align: center; }
  .col-result { width: 80px; }
  
  /* Compact Inputs */
  .col-journal select { width: 100%; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }

  /* Enhanced Number Visualization */
  input.grade-display {
    text-align: center;
    font-weight: 600;
    color: #334155;
  }
  
  /* State: Fixed/ReadOnly */
  input.grade-fixed {
    background-color: #f1f5f9;
    color: #64748b;
    border-color: #e2e8f0;
  }
  /* State: Editable */
  input.grade-editable {
    background-color: #fff;
    color: #0f1724;
    border-color: #3b82f6; /* Blue border to indicate editability */
  }

  input.result-display {
    border: 1px solid #94a3b8;
    background-color: #fff;
    font-weight: 700;
    font-size: 14px;
    text-align: center;
  }
  .res-threshold { color: #2563eb; background: #eff6ff !important; border-color: #bfdbfe !important; }
  .res-norm { color: #059669; background: #ecfdf5 !important; border-color: #a7f3d0 !important; }
  .res-part { background: #f8fafc !important; color: #475569; }

  /* Buttons */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 8px 16px; border-radius: 6px; border: none;
    background: #2563eb; color: #fff; cursor: pointer;
    font-weight: 500; font-size: 13px; transition: 0.2s;
    margin-right: 8px;
  }
  .btn:hover { background: #1d4ed8; }
  .btn.secondary { background: #fff; border: 1px solid #cbd5e1; color: #334155; }
  .btn.secondary:hover { background: #f1f5f9; }
  .btn.danger { background: #fee2e2; color: #991b1b; }
  .btn.danger:hover { background: #fecaca; }
  .btn-calc {
    background: #e2e8f0; color: #475569; border: 1px solid #cbd5e1;
    padding: 2px 6px; font-size: 11px; border-radius: 4px; 
    cursor: pointer; margin-left: 4px; display: none;
  }
  .btn-calc:hover { background: #cbd5e1; }
  
  .del-btn {
    background: #ef4444; color: white; width: 24px; height: 24px;
    border: none; border-radius: 4px; cursor: pointer; display: flex;
    align-items: center; justify-content: center; margin: 0 auto;
  }

  /* Summary Section */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }
  .summary-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
  }
  .summary-label { font-size: 13px; color: #64748b; margin-bottom: 5px; }
  .summary-val { font-size: 28px; font-weight: 800; line-height: 1.2; }
  .val-blue { color: #2563eb; }
  .val-teal { color: #0d9488; }
  
  .status-box { margin-top: 15px; padding: 12px; border-radius: 6px; font-size: 14px; font-weight: 500; }
  .status-ok { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
  .status-warn { background: #fff7ed; color: #9a3412; border: 1px solid #fed7aa; }

  .actions { display: flex; gap: 8px; margin-bottom: 15px; }
  footer { text-align: center; font-size: 12px; color: #94a3b8; margin-top: auto; padding-top: 20px; }

  /* Modal Styling */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
  }
  .modal {
    background: white; padding: 25px; border-radius: 12px;
    width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  .modal h3 { margin-top: 0; color: #0f1724; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 15px; }
  .criteria-list { display: flex; flex-direction: column; gap: 10px; }
  .criteria-item { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
  .criteria-item span { flex: 1; margin-right: 10px; }
  .criteria-item input { width: 20px; height: 20px; }
  .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #e2e8f0; padding-top: 15px; }

  @media print {
    .actions, .del-btn, footer, .btn-calc { display: none !important; }
    body { background: #fff; padding: 0; }
    .card { box-shadow: none; border: none; margin: 0; padding: 0; max-width: 100%; }
    input, select { border: none; background: transparent; appearance: none; padding: 0; }
    .table-wrapper { border: none; }
    th { border-bottom: 2px solid #000; }
  }
</style>
</head>
<body>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h1>Scientific Research Evaluation Points Calculator – Cycle 15</h1>
        <p class="muted">Updated with Conference Criteria & Non-Classified Journal Calculator.</p>
      </div>
    </div>

    <div class="actions">
      <button id="addRowBtn" class="btn">+ Add New Paper</button>
      <button id="exportCSV" class="btn secondary">Export CSV</button>
      <button id="printBtn" class="btn secondary">Print Report</button>
      <button id="resetBtn" class="btn danger" style="margin-left:auto">Reset All</button>
    </div>

    <div class="table-wrapper">
      <table id="researchTable">
        <thead>
          <tr>
            <th class="col-idx">#</th>
            <th class="col-title">Paper Title</th>
            <th class="col-journal">Journal / Conference Type</th>
            <th class="col-spec">Specialty</th>
            <th class="col-eval">Eval Type</th>
            <th class="col-grade-sm">Paper<br>Grade</th>
            <th class="col-grade-sm">Journal<br>Grade</th>
            <th class="col-num">No.<br>Auth</th>
            <th class="col-rank">Your Rank</th>
            <th class="col-check">Top<br>1%</th>
            <th class="col-result">Share %</th>
            <th class="col-check">CNCI<br>>1</th>
            <th class="col-result">Excellence<br>Points</th>
            <th class="col-result">Promo<br>Points</th>
            <th class="col-check"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-label">Total Excellence Points (Min 60)</div>
        <div class="summary-val val-blue" id="sumThreshold">0.00</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Total Promotion Points (Normalized)</div>
        <div class="summary-val val-teal" id="sumNormalized">0.00</div>
      </div>
      <div class="summary-card" style="flex:2">
         <div class="summary-label">Status</div>
         <div id="resultMsg"></div>
      </div>
    </div>
    
    <div id="pageMsg" style="margin-top:10px; font-size:13px; color:#0369a1; font-weight:600; text-align:right"></div>
  </div>

  <footer>Designed based on Cycle 15 Regulations</footer>

  <!-- Modal for Calculator -->
  <div id="calcModal" class="modal-overlay">
    <div class="modal">
      <h3>Journal Grade Calculator (المجلات غير المصنفة)</h3>
      <div class="criteria-list">
        <div class="criteria-item">
            <span>Issued by known scientific entity (دورية تصدر عن جهة علمية معروفة)</span>
            <input type="checkbox" data-val="1.0">
        </div>
        <div class="criteria-item">
            <span>Regular issuance (دورية منتظمة الإصدار)</span>
            <input type="checkbox" data-val="1.0">
        </div>
        <div class="criteria-item">
            <span>Indexed in databases (EKB, DOAJ) (دورية مكشفة)</span>
            <input type="checkbox" data-val="1.0">
        </div>
        <div class="criteria-item">
            <span>Blind Peer Review (دورية محكمة تحكيمًا أعمى)</span>
            <input type="checkbox" data-val="1.0">
        </div>
        <div class="criteria-item">
            <span>Specialized / Sections (دورية متخصصة)</span>
            <input type="checkbox" data-val="1.0">
        </div>
        <div class="criteria-item">
            <span>Electronic Management System (نظام إلكتروني للإدارة والتحكيم)</span>
            <input type="checkbox" data-val="1.0">
        </div>
        <div class="criteria-item">
            <span>Website with full papers (موقع إلكتروني للأبحاث)</span>
            <input type="checkbox" data-val="0.5">
        </div>
        <div class="criteria-item">
            <span>External Editors (يشارك في تحريرها علماء خارجيون)</span>
            <input type="checkbox" data-val="0.5">
        </div>
      </div>
      <div style="margin-top:15px; font-weight:700; display:flex; justify-content:space-between; color:#2563eb;">
          <span>Total Score (Max 7.0):</span>
          <span id="modalTotal">0.0</span>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="closeModal()">Cancel</button>
        <button class="btn" onclick="applyModalScore()">Apply Score</button>
      </div>
    </div>
  </div>

<script>
// 1. DATABASE CONFIGURATION
// Structure: Key -> { fixed: boolean, specialized: {r, j}, general: {r, j}, isConf: boolean, isManual: boolean }
const gradesDB = {
  // --- JOURNALS (Q1-Q4) ---
  "WoS Q1": {
    fixed: true,
    specialized: { research: 100, journal: 10.0 }, // q1 specialized wos 10
    general:     { research: 0,   journal: 9.0 }   // q1 wos unspecialized 9
  },
  "WoS Q2 / Scopus Top 10%": {
    fixed: true,
    specialized: { research: 80, journal: 9.5 },   // q2 wos or q1 scopus top10 9.5 specialized
    general:     { research: 0,  journal: 8.5 }    // q2 wos unspecialized 8.5
  },
  "Scopus Q1 (Standard)": {
    fixed: true,
    specialized: { research: 75, journal: 9.0 },
    general:     { research: 0,  journal: 8.5 }    // q1 scopus unspecialized 8.5
  },
  "WoS Q3 / Scopus Q2": {
    fixed: false,
    specialized: { research: 70, journal: 8.5 },   // q3 wos , q2 scopus specialized 8.5
    general:     { research: 0,  journal: 8.0 }    // q3 wos , q2 scopus unspecialized 8
  },
  "WoS Q4 / Scopus Q3": {
    fixed: false,
    specialized: { research: 65, journal: 8.0 },   // q4 wos , q3 scopus specialized 8
    general:     { research: 0,  journal: 7.5 }    // q4 wos , q3 scopus unspecialized 7.5
  },
  "Scopus Q4": {
    fixed: false,
    specialized: { research: 60, journal: 7.5 },   // q4 scopus specialized 7.5
    general:     { research: 0,  journal: 7.0 }    // q4 scopus , unspecialized 7
  },
  
  // --- CONFERENCES (Table 3) ---
  "Conf: Intl Specialized Scopus/WoS (Q4 equiv) (7.5)": {
    fixed: false, // Paper grade needs eval
    isConf: true,
    specialized: { research: 60, journal: 7.5 }, 
    general:     { research: 0,  journal: 7.5 }
  },
  "Conf: Classified Specialized (Pub + Full Rev) (6.5)": {
    fixed: false,
    isConf: true,
    specialized: { research: 0, journal: 6.5 },
    general:     { research: 0, journal: 6.5 }
  },
  "Conf: Classified Specialized (Full Rev) (5.0)": {
    fixed: false,
    isConf: true,
    specialized: { research: 0, journal: 5.0 },
    general:     { research: 0, journal: 5.0 }
  },
  "Conf: Unclassified Specialized (Abs Rev) (4.5)": {
    fixed: false,
    isConf: true,
    specialized: { research: 0, journal: 4.5 },
    general:     { research: 0, journal: 4.5 }
  },
  "Conf: Classified Non-Spec (Abs Rev) (4.0)": {
    fixed: false,
    isConf: true,
    specialized: { research: 0, journal: 4.0 },
    general:     { research: 0, journal: 4.0 }
  },
  "Conf: Classified Specialized (Unpub + Full Rev) (4.0)": {
    fixed: false,
    isConf: true,
    specialized: { research: 0, journal: 4.0 },
    general:     { research: 0, journal: 4.0 }
  },
  "Conf: Unclassified Specialized (Abs Rev - Type 2) (2.5)": {
    fixed: false,
    isConf: true,
    specialized: { research: 0, journal: 2.5 },
    general:     { research: 0, journal: 2.5 }
  },
  "Conf: Unclassified Specialized (Pub + Full Rev) (2.0)": {
    fixed: false,
    isConf: true,
    specialized: { research: 0, journal: 2.0 },
    general:     { research: 0, journal: 2.0 }
  },
  "Conf: Unclassified Non-Spec (Abs Rev) (1.0)": {
    fixed: false,
    isConf: true,
    specialized: { research: 0, journal: 1.0 },
    general:     { research: 0, journal: 1.0 }
  },

  // --- NON-CLASSIFIED JOURNAL (Table 2) ---
  "Non-Classified Journal (Manual Calc)": {
    fixed: false,
    isManual: true,
    specialized: { research: 0, journal: 0.0 }, // Journal grade calculated manually
    general:     { research: 0, journal: 0.0 }
  }
};

const journalOptions = Object.keys(gradesDB);
const tbody = document.getElementById('tbody');
const sumThresholdEl = document.getElementById('sumThreshold');
const sumNormalizedEl = document.getElementById('sumNormalized');
const resultMsg = document.getElementById('resultMsg');
const pageMsg = document.getElementById('pageMsg');
const calcModal = document.getElementById('calcModal');
let activeCalcRow = null;

function createSelectJournal(selectedKey) {
  const s = document.createElement('select');
  journalOptions.forEach(key => {
    const o = document.createElement('option');
    o.value = key;
    o.textContent = key;
    if (key === selectedKey) o.selected = true;
    s.appendChild(o);
  });
  return s;
}

function createRow(data = {}, idx) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="col-idx">${idx}</td>
    <td class="col-title"><input type="text" class="title" value="${data.title||''}" placeholder="Paper title..."></td>
    <td class="col-journal"></td>
    <td class="col-spec"><select class="spec"><option value="specialized">Specialized</option><option value="general">General</option></select></td>
    <td class="col-eval"><select class="evalType"><option value="excellence">Excellence</option><option value="evaluation">Evaluation</option></select></td>
    <td class="col-grade-sm"><input type="number" class="researchGrade grade-display" value="0" min="0" max="100" step="1"></td>
    <td class="col-grade-sm" style="display:flex; align-items:center;">
        <input type="number" class="journalGrade grade-display" value="0" readonly style="width:50px">
        <button class="btn-calc" type="button">Calc</button>
    </td>
    <td class="col-num"><input type="number" class="numResearchers" value="${data.researchers||1}" min="1" style="text-align:center"></td>
    <td class="col-rank">
        <select class="position">
            <option value="first_last">First/Last</option>
            <option value="middle">Co-Author</option>
            <option value="sole">Sole Author</option>
        </select>
    </td>
    <td class="col-check"><input type="checkbox" class="isTop1"${data.isTop1?' checked':''}></td>
    <td class="col-result"><input type="text" class="participation result-display res-part" readonly></td>
    <td class="col-check"><input type="checkbox" class="cnci"${data.cnci?' checked':''}></td>
    <td class="col-result"><input type="number" class="thresholdPoints result-display res-threshold" readonly></td>
    <td class="col-result"><input type="number" class="normalizedPoints result-display res-norm" readonly></td>
    <td class="col-check"><button class="del-btn">×</button></td>`;
  
  const journalCell = tr.querySelector('.col-journal');
  const defaultKey = data.journalKey || "WoS Q3 / Scopus Q2";
  const sel = createSelectJournal(defaultKey); 
  journalCell.appendChild(sel);
  
  const specSel = tr.querySelector('.spec');
  const researchInput = tr.querySelector('.researchGrade');
  const journalInput = tr.querySelector('.journalGrade');
  const calcBtn = tr.querySelector('.btn-calc');

  // --- REFRESH LOGIC ---
  function refreshGrades() {
    const key = sel.value;
    const spec = specSel.value; 
    const entry = gradesDB[key];
    
    if (!entry) return;

    const values = entry[spec];

    // 1. Research Grade Logic
    // Only lock if it's a "Fixed" tier (Top journals) AND Specialized
    if (entry.fixed && spec === 'specialized') {
        researchInput.value = values.research;
        researchInput.readOnly = true;
        researchInput.className = "researchGrade grade-display grade-fixed"; 
    } else {
        researchInput.readOnly = false;
        researchInput.className = "researchGrade grade-display grade-editable";
        
        // Suggest value if 0 and exists in DB
        if (parseFloat(researchInput.value) === 0 && values.research > 0) {
            researchInput.value = values.research;
        }
    }
    
    // 2. Journal Grade Logic
    if (entry.isManual) {
        // Non-Classified Manual
        calcBtn.style.display = 'inline-block';
        journalInput.readOnly = true; // Read only, set by calc
        journalInput.className = "journalGrade grade-display grade-editable";
        // Do not overwrite existing value if user already calculated
    } else {
        // Standard or Conference
        calcBtn.style.display = 'none';
        journalInput.value = values.journal;
        journalInput.readOnly = true;
        journalInput.className = "journalGrade grade-display grade-fixed";
    }
  }

  // Calc Button Logic
  calcBtn.onclick = () => {
      activeCalcRow = tr;
      openModal();
  };

  // Event Listeners
  sel.onchange = () => { refreshGrades(); calculateAll(); };
  specSel.onchange = () => { refreshGrades(); calculateAll(); };
  
  researchInput.oninput = calculateAll;
  tr.querySelector('.evalType').onchange = calculateAll;
  tr.querySelector('.numResearchers').oninput = calculateAll;
  tr.querySelector('.position').onchange = calculateAll;
  tr.querySelector('.isTop1').onchange = calculateAll;
  tr.querySelector('.cnci').onchange = calculateAll;
  tr.querySelector('.del-btn').onclick = () => { tr.remove(); refreshRowIndices(); calculateAll(); };
  
  refreshGrades();
  return tr;
}

function addResearchRow(d) {
    const r = createRow(d, tbody.children.length + 1);
    tbody.appendChild(r);
    refreshRowIndices();
}

function refreshRowIndices() {
    [...tbody.children].forEach((tr, i) => tr.children[0].textContent = i + 1);
}

function calculateAll() {
  let totalT = 0, totalN = 0;
  
  [...tbody.children].forEach(tr => {
    const rg = parseFloat(tr.querySelector('.researchGrade').value) || 0;
    const jg = parseFloat(tr.querySelector('.journalGrade').value) || 0;
    const n = parseInt(tr.querySelector('.numResearchers').value) || 1;
    const pos = tr.querySelector('.position').value;
    const top = tr.querySelector('.isTop1').checked;
    const cnci = tr.querySelector('.cnci').checked;

    let part = 0;
    const isTenPoints = (jg >= 9.9); // Approximate for 10.0

    if (top || pos === 'sole' || pos === 'first_last') {
        part = 1.0;
    } 
    else if (isTenPoints) {
        if (n <= 4) part = 1.0;
        else if (n <= 6) part = 0.8;
        else part = 0.6; 
    } 
    else {
        if (n === 1) part = 1.0;
        else if (n === 2) part = 0.8;
        else if (n === 3) part = 0.7;
        else if (n === 4) part = 0.55;
        else part = 0.4; 
    }

    const bonus = (cnci && rg > 0) ? 1 : 0;
    
    let th = (rg * part) + bonus;
    if(th > 25) th = 25;
    
    const norm = ((rg * part * jg) / 50) + bonus;

    tr.querySelector('.participation').value = Math.round(part * 100) + '%';
    tr.querySelector('.thresholdPoints').value = th.toFixed(2);
    tr.querySelector('.normalizedPoints').value = norm.toFixed(2);

    const spec = tr.querySelector('.spec').value;
    const evalType = tr.querySelector('.evalType').value;
    
    if (spec === 'specialized') {
        totalN += norm;
        if (evalType === 'excellence') totalT += th;
    }
  });

  sumThresholdEl.textContent = totalT.toFixed(2);
  sumNormalizedEl.textContent = totalN.toFixed(2);
  
  if (totalT >= 60) {
      resultMsg.innerHTML = `<div class="status-ok">✅ <b>Congratulations!</b> Requirement Met (${totalT.toFixed(2)} ≥ 60)</div>`;
  } else {
      resultMsg.innerHTML = `<div class="status-warn">⚠️ <b>Attention:</b> ${totalT.toFixed(2)} is below the required 60 points.</div>`;
  }
}

// --- MODAL LOGIC ---
const checkboxes = document.querySelectorAll('#calcModal input[type="checkbox"]');
const modalTotalEl = document.getElementById('modalTotal');

function openModal() {
    // Reset checks
    checkboxes.forEach(cb => cb.checked = false);
    updateModalTotal();
    calcModal.style.display = 'flex';
}

function closeModal() {
    calcModal.style.display = 'none';
    activeCalcRow = null;
}

function updateModalTotal() {
    let sum = 0;
    checkboxes.forEach(cb => {
        if(cb.checked) sum += parseFloat(cb.getAttribute('data-val'));
    });
    // Max 7.0
    if(sum > 7.0) sum = 7.0;
    modalTotalEl.textContent = sum.toFixed(1);
}

function applyModalScore() {
    if(activeCalcRow) {
        const score = parseFloat(modalTotalEl.textContent);
        activeCalcRow.querySelector('.journalGrade').value = score;
        calculateAll();
    }
    closeModal();
}

checkboxes.forEach(cb => cb.addEventListener('change', updateModalTotal));
// Close if clicked outside
calcModal.addEventListener('click', (e) => {
    if(e.target === calcModal) closeModal();
});


function exportCSV() {
  const rows = [["#", "Title", "Journal", "Spec", "Type", "Grade", "J.Grade", "Auth", "Share", "CNCI", "Exc.Pts", "Promo.Pts"]];
  [...tbody.children].forEach((tr, i) => {
    rows.push([
        i + 1,
        `"${tr.querySelector('.title').value}"`, 
        tr.querySelector('.col-journal select').value,
        tr.querySelector('.spec').value,
        tr.querySelector('.evalType').value,
        tr.querySelector('.researchGrade').value,
        tr.querySelector('.journalGrade').value,
        tr.querySelector('.numResearchers').value,
        tr.querySelector('.participation').value,
        tr.querySelector('.cnci').checked ? 'Yes' : 'No',
        tr.querySelector('.thresholdPoints').value,
        tr.querySelector('.normalizedPoints').value
    ]);
  });
  const csv = "\uFEFF" + rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'scientific_calc_export.csv';
  a.click();
  pageMsg.textContent = "CSV Exported Successfully ✅";
  setTimeout(() => pageMsg.textContent = "", 3000);
}

function init() {
  addResearchRow({
      title: "Fixed Grade Example", 
      journalKey: "WoS Q2 / Scopus Top 10%", 
      researchers: 1,
      isTop1: false
  });

  addResearchRow({
      title: "Conference Example", 
      journalKey: "Conf: Classified Specialized (Full Rev) (5.0)", 
      researchers: 1,
      isTop1: false
  });
  
  document.getElementById('addRowBtn').onclick = () => { addResearchRow({}); calculateAll(); };
  document.getElementById('exportCSV').onclick = exportCSV;
  document.getElementById('printBtn').onclick = () => window.print();
  document.getElementById('resetBtn').onclick = () => {
    if (confirm('Are you sure you want to reset all data?')) {
        tbody.innerHTML = ''; addResearchRow({}); calculateAll();
        pageMsg.textContent = "Reset Complete";
        setTimeout(() => pageMsg.textContent = "", 2000);
    }
  };
  calculateAll();
}
init();
</script>
</body>
</html>
