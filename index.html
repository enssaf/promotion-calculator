<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>حاسبة نقاط التميز العلمي - الدورة 15 (جدول محدث)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
  body{font-family:'Tajawal',Arial,sans-serif;background:#f4f6f8;color:#0f1724;padding:18px;direction:rtl;min-height:100vh;display:flex;flex-direction:column}
  .card{background:#fff;border-radius:10px;padding:16px;margin:12px auto;max-width:1250px;box-shadow:0 6px 18px rgba(15,23,36,0.06);width:100%;box-sizing:border-box;}
  h1{margin:0 0 8px;font-size:20px;color:#1e293b}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden}
  th,td{border-bottom:1px solid #e2e8f0;border-left:1px solid #e2e8f0;padding:8px;text-align:right;font-size:13px}
  th:last-child, td:last-child {border-left:none;}
  th{background:#f8fafc;font-weight:700;color:#334155}
  input[type="text"], input[type="number"], select{width:100%;padding:6px;border:1px solid #cbd5e1;border-radius:6px;font-size:13px;box-sizing:border-box;font-family:'Tajawal',sans-serif;}
  input:focus, select:focus {outline:2px solid #2563eb;border-color:#2563eb;}
  .btn{display:inline-block;padding:8px 14px;border-radius:6px;border:none;background:#2563eb;color:#fff;cursor:pointer;font-weight:600;margin:6px 6px 0 0;transition:0.2s}
  .btn:hover{background:#1d4ed8}
  .btn.secondary{background:#0ea5a4}
  .btn.secondary:hover{background:#0d9488}
  .muted{color:#64748b;font-size:13px;line-height:1.5}
  .result{margin-top:16px;padding:16px;border-radius:8px;background:#f8fafc;border:1px solid #e2e8f0}
  .ok{background:#dcfce7;color:#166534;border:1px solid #86efac;padding:10px;border-radius:6px;margin-top:8px}
  .warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa;padding:10px;border-radius:6px;margin-top:8px}
  .small{font-size:12px;color:#64748b}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;padding-bottom:12px;border-bottom:1px solid #e2e8f0}
  
  /* Table Inputs Specifics */
  .journalCell select {min-width: 180px;}
  input.researchGrade, input.journalGrade {background-color: #f1f5f9; font-weight: bold;}
  
  footer{text-align:center;font-size:12px;color:#94a3b8;margin-top:auto;padding-top:20px}
  
  @media print {
    .actions, .delBtn, footer {display:none !important;}
    body {background:#fff; padding:0;}
    .card {box-shadow:none; border:none; margin:0; padding:0; max-width:100%;}
    input, select {border:none; background:transparent; -webkit-appearance:none; padding:0;}
  }
</style>
</head>
<body>
  <div class="card">
   <h1>حاسبة نقاط تقييم الأبحاث للترقيات — الدورة 15</h1>
   <p class="muted">حساب نقاط تقييم الأبحاث وفقاً لقواعد الدورة الخامسة عشرة وجدول تقييم المجلات المحدث.</p>

    <div class="actions">
      <button id="addRowBtn" class="btn">إضافة بحث جديد +</button>
      <button id="exportCSV" class="btn secondary">تصدير CSV</button>
      <button id="printBtn" class="btn secondary">طباعة التقرير</button>
      <button id="resetBtn" class="btn" style="background:#ef4444">إعادة ضبط الكل</button>
    </div>

    <div style="overflow-x:auto;">
      <table id="researchTable">
        <thead>
          <tr>
            <th width="3%">#</th>
            <th width="20%">عنوان البحث</th>
            <th width="15%">نوع المجلة</th>
            <th width="8%">التخصص</th>
            <th width="8%">نوع التقييم</th>
            <th width="5%">درجة البحث</th>
            <th width="5%">درجة المجلة</th>
            <th width="5%">عدد الباحثين</th>
            <th width="8%">ترتيبك</th>
            <th width="4%">Top 1%</th>
            <th width="5%">نسبة المشاركة</th>
            <th width="4%">CNCI >1</th>
            <th width="5%">نقاط التميز</th>
            <th width="5%">النقاط (المعادلة)</th>
            <th width="5%">حذف</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="result" id="summary">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap; gap:20px;">
        <div style="flex:1; min-width:200px;">
          <div class="small">مجموع نقاط التميز (شرط المادة 23 — الحد الأدنى 60):</div>
          <div style="font-size:24px;font-weight:700;color:#2563eb" id="sumThreshold">0.00</div>
        </div>
        <div style="flex:1; min-width:200px;">
          <div class="small">المجموع الكلي (المعادلة الجديدة للترقية):</div>
          <div style="font-size:24px;font-weight:700;color:#0ea5a4;text-align:left;direction:ltr" id="sumNormalized">0.00</div>
        </div>
      </div>
      <div id="resultMsg"></div>
      <div id="pageMsg" style="margin-top:10px;font-size:13px;color:#0369a1;font-weight:bold"></div>
    </div>
  </div>

  <footer>Designed by: Dr. Ensaf H. Mohamed</footer>

<script>
// 1. DATABASE CONFIGURATION (UPDATED TABLE)
const gradesDB = {
  // Grade 10.0
  "WoS Q1 - Top 10%|متخصص": { researchGrade: 100, journalGrade: 10 },
  "WoS Q1 - (Other)|متخصص": { researchGrade: 90, journalGrade: 10 },
  
  // Grade 9.5
  "WoS Q2|متخصص": { researchGrade: 80, journalGrade: 9.5 },
  "Scopus Top 10% (Class A)|متخصص": { researchGrade: 80, journalGrade: 9.5 },
  
  // Grade 9.0
  "Scopus Q1|متخصص": { researchGrade: 75, journalGrade: 9.0 },
  
  // Grade 8.5
  "WoS Q3|متخصص": { researchGrade: 70, journalGrade: 8.5 },
  
  // Grade 8.0
  "Scopus Q2|متخصص": { researchGrade: 70, journalGrade: 8.0 },
  
  // Grade 7.5
  "WoS Q4|متخصص": { researchGrade: 65, journalGrade: 7.5 },
  "Scopus Q3|متخصص": { researchGrade: 65, journalGrade: 7.5 },
  
  // Grade 7.0
  "Scopus Q4|متخصص": { researchGrade: 60, journalGrade: 7.0 },
  "ESCI (WoS/Scopus Emerging)|متخصص": { researchGrade: 60, journalGrade: 7.0 },
  
  // غير متخصص (للرجوع إليها)
  "WoS Q1|غير متخصص": { researchGrade: 0, journalGrade: 6 },
  "WoS Q2|غير متخصص": { researchGrade: 0, journalGrade: 5.5 },
  "WoS Q3|غير متخصص": { researchGrade: 0, journalGrade: 4 },
  "WoS Q4|غير متخصص": { researchGrade: 0, journalGrade: 3 },
  "Scopus Q1|غير متخصص": { researchGrade: 0, journalGrade: 5 },
  "Scopus Q2|غير متخصص": { researchGrade: 0, journalGrade: 4.5 },
  "Scopus Q3|غير متخصص": { researchGrade: 0, journalGrade: 3.5 },
  "Scopus Q4|غير متخصص": { researchGrade: 0, journalGrade: 2.5 },
  "Evaluation (Other)|غير متخصص": { researchGrade: 0, journalGrade: 0 }
};

const journalOptions = Object.keys(gradesDB).map(k=>{
  const [label,spec]=k.split('|');
  return {key:k,label:label+" — "+spec};
});

const tbody=document.getElementById('tbody');
const sumThresholdEl=document.getElementById('sumThreshold');
const sumNormalizedEl=document.getElementById('sumNormalized');
const resultMsg=document.getElementById('resultMsg');
const pageMsg=document.getElementById('pageMsg');

function createSelectJournal(selectedKey){
  const s=document.createElement('select');
  journalOptions.forEach(opt=>{
    const o=document.createElement('option');
    o.value=opt.key;o.textContent=opt.label;
    if(opt.key===selectedKey) o.selected=true;
    s.appendChild(o);
  });
  return s;
}

function createRow(data={},idx){
  const tr=document.createElement('tr');
  tr.innerHTML=`
  <td>${idx}</td>
  <td><input type="text" class="title" value="${data.title||''}" placeholder="عنوان البحث..."></td>
  <td class="journalCell"></td>
  <td><select class="spec"><option>متخصص</option><option>غير متخصص</option></select></td>
  <td><select class="evalType"><option value="excellence">تميز علمي</option><option value="evaluation">تقييم</option></select></td>
  <td><input type="number" class="researchGrade" value="0"></td>
  <td><input type="number" class="journalGrade" value="0" readonly></td>
  <td><input type="number" class="numResearchers" value="${data.researchers||1}" min="1"></td>
  <td><select class="position"><option value="first_last">الأول/الأخير</option><option value="middle">مشارك</option><option value="sole">منفرد</option></select></td>
  <td><input type="checkbox" class="isTop1"${data.isTop1?' checked':''}></td>
  <td><input type="text" class="participation" readonly style="background:#eee;color:#333;text-align:center"></td>
  <td><input type="checkbox" class="cnci"${data.cnci?' checked':''}></td>
  <td><input type="number" class="thresholdPoints" value="0" readonly style="color:#2563eb;font-weight:bold"></td>
  <td><input type="number" class="normalizedPoints" value="0" readonly style="color:#0ea5a4;font-weight:bold"></td>
  <td><button class="delBtn" style="background:#ef4444;padding:4px 8px;font-size:11px">X</button></td>`;
  
  const journalCell=tr.querySelector('.journalCell');
  const sel=createSelectJournal(data.journalKey||journalOptions[2].key); // Default to WoS Q2
  journalCell.appendChild(sel);
  
  const specSel=tr.querySelector('.spec');
  // Initialize spec based on Key
  specSel.value = sel.value.split('|')[1] || 'متخصص';

  const researchInput = tr.querySelector('.researchGrade');
  const evalTypeSel = tr.querySelector('.evalType');

  // وظيفة تحديث الدرجات
  function refreshGrades(){
    const key=sel.value;
    const base=gradesDB[key]||{researchGrade:0,journalGrade:0};
    const evalType=evalTypeSel.value;
    const isSpec=specSel.value==='متخصص';
    const label=key.split('|')[0];
    
    // شرط التميز العلمي:
    const isEligible = isSpec && (
        label.includes('WoS Q1') || 
        label.includes('WoS Q2') || 
        label.includes('Scopus Q1') || 
        label.includes('Scopus Top 10%')
    );

    // منطق التميز vs التقييم
    if(evalType==='excellence'){
        if(isEligible) {
            researchInput.value = base.researchGrade;
            researchInput.readOnly = true;
            researchInput.style.backgroundColor = "#e2e8f0";
            researchInput.placeholder = "";
        } else {
            researchInput.value = 0;
            researchInput.readOnly = true;
            researchInput.style.backgroundColor = "#e2e8f0";
        }
    } else {
        // حالة التقييم: إدخال يدوي
        researchInput.readOnly = false;
        researchInput.style.backgroundColor = "#fff";
        researchInput.placeholder = "أدخل الدرجة";
    }
    
    tr.querySelector('.journalGrade').value=base.journalGrade;
  }

  // Event Listeners
  sel.onchange = () => {
      specSel.value = sel.value.split('|')[1] || 'متخصص';
      refreshGrades(); calculateAll();
  };
  specSel.onchange=evalTypeSel.onchange=()=>{refreshGrades();calculateAll();};
  
  researchInput.oninput=calculateAll;
  tr.querySelector('.numResearchers').oninput=calculateAll;
  tr.querySelector('.position').onchange=calculateAll;
  tr.querySelector('.isTop1').onchange=calculateAll;
  tr.querySelector('.cnci').onchange=calculateAll;
  tr.querySelector('.delBtn').onclick=()=>{tr.remove();refreshRowIndices();calculateAll();};
  
  refreshGrades();
  return tr;
}

function addResearchRow(d){const r=createRow(d,tbody.children.length+1);tbody.appendChild(r);refreshRowIndices();}
function refreshRowIndices(){[...tbody.children].forEach((tr,i)=>tr.children[0].textContent=i+1);}

function calculateAll(){
  let totalT=0,totalN=0;
  [...tbody.children].forEach(tr=>{
    const rg=parseFloat(tr.querySelector('.researchGrade').value)||0;
    const jg=parseFloat(tr.querySelector('.journalGrade').value)||0;
    const n=parseInt(tr.querySelector('.numResearchers').value)||1;
    const pos=tr.querySelector('.position').value;
    const top=tr.querySelector('.isTop1').checked;
    const cnci=tr.querySelector('.cnci').checked;

// --- منطق نسبة المشاركة (المادة 22) ---
let part = 0;

// هل المجلة 10 نقاط؟
const isTenPoints = (jg === 10);

// 1️⃣ حالات 100% دائمًا بغض النظر عن العدد
if (
    top ||                 // مجلة ضمن أعلى 1%
    pos === 'sole' ||      // الباحث الوحيد في تخصصه
    pos === 'first_last'   // الأول أو الأخير
) {
    part = 1.0;

} else if (isTenPoints) {
    // 2️⃣ مجلات 10 نقاط
    if (n <= 4) {
        part = 1.0;
    } else if (n === 5 || n === 6) {
        part = 0.8;
    } else {
        part = 0.6; // 7 فأكثر
    }

} else {
    // 3️⃣ مجلات عادية (أقل من 10 نقاط)
    if (n === 1) {
        part = 1.0;        // عمليًا متخصص وحيد
    } else if (n === 2) {
        part = 0.8;
    } else if (n === 3) {
        part = 0.7;
    } else if (n === 4) {
        part = 0.55;
    } else {
        part = 0.4;        // 5 فأكثر
    }
}


    // CNCI Bonus
    const bonus=(cnci && rg > 0)?1:0;
    
    // نقاط التميز
    const th = Math.min(25, (rg * part) + bonus);
    
    // المعادلة
    const norm = ((rg * part * jg) / 50) + bonus;

    tr.querySelector('.participation').value=Math.round(part*100)+'%';
    tr.querySelector('.thresholdPoints').value=th.toFixed(2);
    tr.querySelector('.normalizedPoints').value=norm.toFixed(2);

    const spec=tr.querySelector('.spec').value;
    const evalType=tr.querySelector('.evalType').value;
    
    // الجمع التراكمي
    if(spec==='متخصص'){
        totalN+=norm;
        if(evalType==='excellence') totalT+=th;
    }
  });

  sumThresholdEl.textContent=totalT.toFixed(2);
  sumNormalizedEl.textContent=totalN.toFixed(2);
  
  if(totalT >= 60) {
      resultMsg.innerHTML=`<div class="ok">✅ <b>مبروك!</b> استوفيت شرط نقاط التميز (${totalT.toFixed(2)} ≥ 60)</div>`;
  } else {
      resultMsg.innerHTML=`<div class="warn">⚠️ <b>تنبيه:</b> مجموع نقاط التميز ${totalT.toFixed(2)} أقل من 60 نقطة المطلوبة.</div>`;
  }
}

function exportCSV(){
  const rows=[["#","عنوان","نوع","تخصص","التقييم","درجة بحث","درجة مجلة","باحثين","نسبة","CNCI","تميز","معدل"]];
  [...tbody.children].forEach((tr,i)=>{
    rows.push([
        i+1,
        `"${tr.querySelector('.title').value}"`, 
        tr.querySelector('.journalCell select').value,
        tr.querySelector('.spec').value,
        tr.querySelector('.evalType').value,
        tr.querySelector('.researchGrade').value,
        tr.querySelector('.journalGrade').value,
        tr.querySelector('.numResearchers').value,
        tr.querySelector('.participation').value,
        tr.querySelector('.cnci').checked?'نعم':'لا',
        tr.querySelector('.thresholdPoints').value,
        tr.querySelector('.normalizedPoints').value
    ]);
  });
  const csv="\uFEFF" + rows.map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='excellence_points.csv';a.click();
  pageMsg.textContent="تم حفظ ملف CSV بنجاح ✅";
  setTimeout(()=>pageMsg.textContent="", 3000);
}

function init(){
  addResearchRow({title:"بحث مثال (Scopus Top 10%)", journalKey:"Scopus Top 10% (Class A)|متخصص", researchers: 1});
  document.getElementById('addRowBtn').onclick=()=>{addResearchRow({});calculateAll();};
  document.getElementById('exportCSV').onclick=exportCSV;
  document.getElementById('printBtn').onclick=()=>window.print();
  document.getElementById('resetBtn').onclick=()=>{
    if(confirm('هل أنت متأكد من حذف جميع البيانات؟')){
        tbody.innerHTML='';addResearchRow({});calculateAll();
        pageMsg.textContent="تمت إعادة الضبط ✅";
        setTimeout(()=>pageMsg.textContent="", 3000);
    }
  };
  calculateAll();
}
init();
</script>
</body>
</html>