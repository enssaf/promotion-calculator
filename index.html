<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Scientific Excellence Calculator - Cycle 15</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
  body{font-family:'Inter',Arial,sans-serif;background:#f4f6f8;color:#0f1724;padding:18px;direction:ltr;min-height:100vh;display:flex;flex-direction:column}
  .card{background:#fff;border-radius:10px;padding:16px;margin:12px auto;max-width:1300px;box-shadow:0 6px 18px rgba(15,23,36,0.06);width:100%;box-sizing:border-box;}
  h1{margin:0 0 8px;font-size:22px;color:#1e293b}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden}
  th,td{border-bottom:1px solid #e2e8f0;border-right:1px solid #e2e8f0;padding:8px;text-align:center;font-size:13px;vertical-align:middle;}
  th:last-child, td:last-child {border-right:none;}
  th{background:#f8fafc;font-weight:700;color:#334155;white-space:nowrap;}
  
  /* Inputs */
  input[type="text"], input[type="number"], select{width:100%;padding:6px;border:1px solid #cbd5e1;border-radius:6px;font-size:13px;box-sizing:border-box;font-family:'Inter',sans-serif;}
  input:focus, select:focus {outline:2px solid #2563eb;border-color:#2563eb;}
  
  /* Number styling for visibility */
  input[type="number"], input.participation, input.thresholdPoints, input.normalizedPoints {
      text-align: center;
      font-weight: 800;
      font-size: 15px;
      color: #0f1724;
  }
  
  /* Highlight Results */
  input.thresholdPoints { color: #2563eb !important; background-color: #eff6ff !important; font-size: 16px !important; }
  input.normalizedPoints { color: #059669 !important; background-color: #ecfdf5 !important; font-size: 16px !important; }

  /* Title Input */
  input.title { font-size: 13px; text-align: left; }

  .btn{display:inline-block;padding:8px 14px;border-radius:6px;border:none;background:#2563eb;color:#fff;cursor:pointer;font-weight:600;margin:0 6px 6px 0;transition:0.2s}
  .btn:hover{background:#1d4ed8}
  .btn.secondary{background:#0ea5a4}
  .btn.secondary:hover{background:#0d9488}
  .btn.danger{background:#ef4444}
  .btn.danger:hover{background:#dc2626}
  
  .muted{color:#64748b;font-size:13px;line-height:1.5}
  .result{margin-top:16px;padding:16px;border-radius:8px;background:#f8fafc;border:1px solid #e2e8f0}
  .ok{background:#dcfce7;color:#166534;border:1px solid #86efac;padding:10px;border-radius:6px;margin-top:8px}
  .warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa;padding:10px;border-radius:6px;margin-top:8px}
  .small{font-size:12px;color:#64748b}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;padding-bottom:12px;border-bottom:1px solid #e2e8f0}
  
  /* Table Specifics */
  .journalCell select {min-width: 140px; font-size: 12px;}
  
  footer{text-align:center;font-size:12px;color:#94a3b8;margin-top:auto;padding-top:20px}
  
  @media print {
    .actions, .delBtn, footer {display:none !important;}
    body {background:#fff; padding:0;}
    .card {box-shadow:none; border:none; margin:0; padding:0; max-width:100%;}
    input, select {border:none; background:transparent; -webkit-appearance:none; padding:0;}
  }
</style>
</head>
<body>
  <div class="card">
   <h1>Scientific Excellence Calculator - Cycle 15</h1>
   <p class="muted">Calculator for promotion points based on Cycle 15 regulations and updated journal grading table.</p>

    <div class="actions">
      <button id="addRowBtn" class="btn">Add Paper +</button>
      <button id="exportCSV" class="btn secondary">Export CSV</button>
      <button id="printBtn" class="btn secondary">Print Report</button>
      <button id="resetBtn" class="btn danger">Reset All</button>
    </div>

    <div style="overflow-x:auto;">
      <table id="researchTable">
        <thead>
          <tr>
            <th width="3%">#</th>
            <th width="25%">Paper Title</th> <!-- WIDENED -->
            <th width="12%">Journal Type</th> <!-- SHRUNK -->
            <th width="8%">Specialty</th>
            <th width="8%">Eval Type</th>
            <th width="5%">Paper Score</th>
            <th width="5%">Journal Score</th>
            <th width="5%">Authors</th>
            <th width="8%">Position</th>
            <th width="4%">Top 1%</th>
            <th width="5%">Share %</th>
            <th width="4%">CNCI >1</th>
            <th width="5%">Exc. Pts</th>
            <th width="5%">Norm. Pts</th>
            <th width="3%">Del</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="result" id="summary">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap; gap:20px;">
        <div style="flex:1; min-width:200px;">
          <div class="small">Total Excellence Points (Min 60):</div>
          <div style="font-size:28px;font-weight:800;color:#2563eb" id="sumThreshold">0.00</div>
        </div>
        <div style="flex:1; min-width:200px;">
          <div class="small">Total Promotion Points:</div>
          <div style="font-size:28px;font-weight:800;color:#059669;text-align:left;" id="sumNormalized">0.00</div>
        </div>
      </div>
      <div id="resultMsg"></div>
      <div id="pageMsg" style="margin-top:10px;font-size:13px;color:#0369a1;font-weight:bold"></div>
    </div>
  </div>

  <footer>Designed & Updated for Cycle 15</footer>

<script>
// 1. DATABASE CONFIGURATION (English Keys)
const gradesDB = {
  // Grade 10.0
  "WoS Q1 - Top 10%|Specialized": { researchGrade: 100, journalGrade: 10 },
  "WoS Q1 - (Other)|Specialized": { researchGrade: 90, journalGrade: 10 },
  
  // Grade 9.5
  "WoS Q2|Specialized": { researchGrade: 80, journalGrade: 9.5 },
  "Scopus Top 10% (Class A)|Specialized": { researchGrade: 80, journalGrade: 9.5 },
  
  // Grade 9.0
  "Scopus Q1|Specialized": { researchGrade: 75, journalGrade: 9.0 },
  
  // Grade 8.5
  "WoS Q3|Specialized": { researchGrade: 70, journalGrade: 8.5 },
  
  // Grade 8.0
  "Scopus Q2|Specialized": { researchGrade: 70, journalGrade: 8.0 },
  
  // Grade 7.5
  "WoS Q4|Specialized": { researchGrade: 65, journalGrade: 7.5 },
  "Scopus Q3|Specialized": { researchGrade: 65, journalGrade: 7.5 },
  
  // Grade 7.0
  "Scopus Q4|Specialized": { researchGrade: 60, journalGrade: 7.0 },
  "ESCI (WoS/Scopus Emerging)|Specialized": { researchGrade: 60, journalGrade: 7.0 },
  
  // Non-Specialized (For reference/fallback)
  "WoS Q1|Non-Specialized": { researchGrade: 0, journalGrade: 6 },
  "WoS Q2|Non-Specialized": { researchGrade: 0, journalGrade: 5.5 },
  "WoS Q3|Non-Specialized": { researchGrade: 0, journalGrade: 4 },
  "WoS Q4|Non-Specialized": { researchGrade: 0, journalGrade: 3 },
  "Scopus Q1|Non-Specialized": { researchGrade: 0, journalGrade: 5 },
  "Scopus Q2|Non-Specialized": { researchGrade: 0, journalGrade: 4.5 },
  "Scopus Q3|Non-Specialized": { researchGrade: 0, journalGrade: 3.5 },
  "Scopus Q4|Non-Specialized": { researchGrade: 0, journalGrade: 2.5 },
  "Evaluation (Other)|Non-Specialized": { researchGrade: 0, journalGrade: 0 }
};

const journalOptions = Object.keys(gradesDB).map(k=>{
  const [label,spec]=k.split('|');
  return {key:k,label:label}; // spec is redundant in label for English layout to save space
});

const tbody=document.getElementById('tbody');
const sumThresholdEl=document.getElementById('sumThreshold');
const sumNormalizedEl=document.getElementById('sumNormalized');
const resultMsg=document.getElementById('resultMsg');
const pageMsg=document.getElementById('pageMsg');

function createSelectJournal(selectedKey){
  const s=document.createElement('select');
  journalOptions.forEach(opt=>{
    const o=document.createElement('option');
    o.value=opt.key;o.textContent=opt.label;
    if(opt.key===selectedKey) o.selected=true;
    s.appendChild(o);
  });
  return s;
}

function createRow(data={},idx){
  const tr=document.createElement('tr');
  tr.innerHTML=`
  <td>${idx}</td>
  <td><input type="text" class="title" value="${data.title||''}" placeholder="Paper title..."></td>
  <td class="journalCell"></td>
  <td><select class="spec"><option value="Specialized">Specialized</option><option value="Non-Specialized">Non-Specialized</option></select></td>
  <td><select class="evalType"><option value="excellence">Excellence</option><option value="evaluation">Evaluation</option></select></td>
  <td><input type="number" class="researchGrade" value="0"></td>
  <td><input type="number" class="journalGrade" value="0" readonly></td>
  <td><input type="number" class="numResearchers" value="${data.researchers||1}" min="1"></td>
  <td><select class="position"><option value="first_last">First/Last</option><option value="middle">Co-author</option><option value="sole">Sole</option></select></td>
  <td><input type="checkbox" class="isTop1"${data.isTop1?' checked':''}></td>
  <td><input type="text" class="participation" readonly style="background:#eee;color:#333;text-align:center"></td>
  <td><input type="checkbox" class="cnci"${data.cnci?' checked':''}></td>
  <td><input type="number" class="thresholdPoints" value="0" readonly></td>
  <td><input type="number" class="normalizedPoints" value="0" readonly></td>
  <td><button class="delBtn" style="background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;padding:4px 8px;">X</button></td>`;
  
  const journalCell=tr.querySelector('.journalCell');
  const sel=createSelectJournal(data.journalKey||journalOptions[2].key); // Default to WoS Q2
  journalCell.appendChild(sel);
  
  const specSel=tr.querySelector('.spec');
  // Initialize spec based on Key
  specSel.value = sel.value.split('|')[1] || 'Specialized';

  const researchInput = tr.querySelector('.researchGrade');
  const evalTypeSel = tr.querySelector('.evalType');

  // Update Grades Function
  function refreshGrades(){
    const key=sel.value;
    const base=gradesDB[key]||{researchGrade:0,journalGrade:0};
    const evalType=evalTypeSel.value;
    const isSpec=specSel.value==='Specialized';
    const label=key.split('|')[0];
    
    // Excellence Eligibility Check:
    const isEligible = isSpec && (
        label.includes('WoS Q1') || 
        label.includes('WoS Q2') || 
        label.includes('Scopus Q1') || 
        label.includes('Scopus Top 10%')
    );

    // Excellence vs Evaluation Logic
    if(evalType==='excellence'){
        if(isEligible) {
            researchInput.value = base.researchGrade;
            researchInput.readOnly = true;
            researchInput.style.backgroundColor = "#e2e8f0";
            researchInput.placeholder = "";
        } else {
            researchInput.value = 0;
            researchInput.readOnly = true;
            researchInput.style.backgroundColor = "#e2e8f0";
        }
    } else {
        // Manual Entry
        researchInput.readOnly = false;
        researchInput.style.backgroundColor = "#fff";
        researchInput.placeholder = "Score";
    }
    
    tr.querySelector('.journalGrade').value=base.journalGrade;
  }

  // Event Listeners
  sel.onchange = () => {
      // Auto-update spec dropdown based on journal choice
      const keyParts = sel.value.split('|');
      if(keyParts.length > 1) {
          specSel.value = keyParts[1];
      }
      refreshGrades(); calculateAll();
  };
  specSel.onchange=evalTypeSel.onchange=()=>{refreshGrades();calculateAll();};
  
  researchInput.oninput=calculateAll;
  tr.querySelector('.numResearchers').oninput=calculateAll;
  tr.querySelector('.position').onchange=calculateAll;
  tr.querySelector('.isTop1').onchange=calculateAll;
  tr.querySelector('.cnci').onchange=calculateAll;
  tr.querySelector('.delBtn').onclick=()=>{tr.remove();refreshRowIndices();calculateAll();};
  
  refreshGrades();
  return tr;
}

function addResearchRow(d){const r=createRow(d,tbody.children.length+1);tbody.appendChild(r);refreshRowIndices();}
function refreshRowIndices(){[...tbody.children].forEach((tr,i)=>tr.children[0].textContent=i+1);}

function calculateAll(){
  let totalT=0,totalN=0;
  [...tbody.children].forEach(tr=>{
    const rg=parseFloat(tr.querySelector('.researchGrade').value)||0;
    const jg=parseFloat(tr.querySelector('.journalGrade').value)||0;
    const n=parseInt(tr.querySelector('.numResearchers').value)||1;
    const pos=tr.querySelector('.position').value;
    const top=tr.querySelector('.isTop1').checked;
    const cnci=tr.querySelector('.cnci').checked;

    // --- Participation Logic (Article 22) ---
    let part = 0;
    
    // Is Journal 10 points?
    const isTenPoints = (jg === 10);

    // Cases that get 100% (1.0) ALWAYS:
    if(top || n === 1 || pos === 'sole' || pos === 'first_last' || (isTenPoints && n <= 4)) {
        part = 1.0;
    } else {
        if (isTenPoints) {
            // 10-point journal with > 4 authors
            if (n === 5 || n === 6) part = 0.8;
            else part = 0.6; // 7+
        } else {
            // Regular journals
            if (n === 2) part = 0.8;
            else if (n === 3) part = 0.55;
            else if (n === 4) part = 0.55;
            else part = 0.50; // 5+
        }
    }

    // CNCI Bonus
    const bonus=(cnci && rg > 0)?1:0;
    
    // Excellence Points
    const th = Math.min(25, (rg * part) + bonus);
    
    // Normalized Points (Formula)
    const norm = ((rg * part * jg) / 50) + bonus;

    tr.querySelector('.participation').value=Math.round(part*100)+'%';
    tr.querySelector('.thresholdPoints').value=th.toFixed(2);
    tr.querySelector('.normalizedPoints').value=norm.toFixed(2);

    const spec=tr.querySelector('.spec').value;
    const evalType=tr.querySelector('.evalType').value;
    
    // Summation
    if(spec==='Specialized'){
        totalN+=norm;
        if(evalType==='excellence') totalT+=th;
    }
  });

  sumThresholdEl.textContent=totalT.toFixed(2);
  sumNormalizedEl.textContent=totalN.toFixed(2);
  
  if(totalT >= 60) {
      resultMsg.innerHTML=`<div class="ok">✅ <b>Congratulations!</b> Excellence condition met (${totalT.toFixed(2)} ≥ 60)</div>`;
  } else {
      resultMsg.innerHTML=`<div class="warn">⚠️ <b>Notice:</b> Excellence points (${totalT.toFixed(2)}) are below the required 60.</div>`;
  }
}

function exportCSV(){
  const rows=[["#","Title","Journal","Specialty","Type","Score","J.Score","Authors","Pos","Top1%","Share","CNCI","Exc.Pts","Norm.Pts"]];
  [...tbody.children].forEach((tr,i)=>{
    rows.push([
        i+1,
        `"${tr.querySelector('.title').value}"`, 
        tr.querySelector('.journalCell select').value,
        tr.querySelector('.spec').value,
        tr.querySelector('.evalType').value,
        tr.querySelector('.researchGrade').value,
        tr.querySelector('.journalGrade').value,
        tr.querySelector('.numResearchers').value,
        tr.querySelector('.position').value,
        tr.querySelector('.isTop1').checked?'Yes':'No',
        tr.querySelector('.participation').value,
        tr.querySelector('.cnci').checked?'Yes':'No',
        tr.querySelector('.thresholdPoints').value,
        tr.querySelector('.normalizedPoints').value
    ]);
  });
  const csv="data:text/csv;charset=utf-8," + rows.map(r=>r.join(',')).join('\n');
  const encodedUri = encodeURI(csv);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "excellence_points.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  pageMsg.textContent="CSV exported successfully ✅";
  setTimeout(()=>pageMsg.textContent="", 3000);
}

function init(){
  addResearchRow({title:"Example Paper (Scopus Top 10%)", journalKey:"Scopus Top 10% (Class A)|Specialized", researchers: 1});
  document.getElementById('addRowBtn').onclick=()=>{addResearchRow({});calculateAll();};
  document.getElementById('exportCSV').onclick=exportCSV;
  document.getElementById('printBtn').onclick=()=>window.print();
  document.getElementById('resetBtn').onclick=()=>{
    if(confirm('Are you sure you want to reset all data?')){
        tbody.innerHTML='';addResearchRow({});calculateAll();
        pageMsg.textContent="Reset Complete ✅";
        setTimeout(()=>pageMsg.textContent="", 3000);
    }
  };
  calculateAll();
}
init();
</script>
</body>
</html>
